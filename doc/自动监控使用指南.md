# 自动监控使用指南

## 📖 概述

本系统现在支持自动监控魔搭仓库 [ageless/3k-animation-mkv-av1](https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1)，当检测到文件夹上传完成时，自动将其加入处理队列并开始处理。

## 🎯 核心功能

- **📡 实时监控**: 每5分钟检查一次魔搭仓库更新
- **🧠 智能检测**: 文件夹10分钟内无变化即认为上传完成
- **⚡ 自动队列**: 完成的文件夹自动加入处理队列
- **🎭 优先级**: 小文件夹优先处理，提高效率
- **📊 状态跟踪**: 完整的处理状态和进度记录

## 🚀 快速启动

### 1. 自动监控模式（推荐）

```bash
# 启动监控系统（包含监控器和处理器）
bash start_monitoring.sh
```

这将启动两个进程：
- **监控器**: 持续监控魔搭仓库变化
- **处理器**: 从队列中取任务并处理

### 2. 手动模式

```bash
# 只运行一次检查
python3 tools/modelscope_monitor.py --once

# 查看当前队列状态
python3 tools/queue_processor.py --status

# 手动处理队列
python3 tools/queue_processor.py
```

## 🔧 配置参数

### 监控器配置

```python
# 在 tools/modelscope_monitor.py 中
class ModelScopeMonitor:
    monitor_interval = 300              # 5分钟检查一次
    min_folder_stable_time = 600        # 10分钟稳定才认为完成
```

### 处理器配置

```python
# 在 tools/queue_processor.py 中
class QueueProcessor:
    check_interval = 60                 # 1分钟检查一次队列
    max_concurrent = 1                  # 最大并发处理数
```

## 📋 管理命令

### 监控管理

```bash
# 查看tmux会话
tmux list-sessions

# 连接到监控器
tmux attach -t animation_monitor:0

# 连接到处理器
tmux attach -t animation_monitor:processor

# 停止整个系统
tmux kill-session -t animation_monitor
```

### 队列管理

```bash
# 查看队列状态
python3 tools/queue_processor.py --status

# 查看监控器队列
python3 tools/modelscope_monitor.py --queue

# 只检查一次仓库
python3 tools/modelscope_monitor.py --once
```

### 日志查看

```bash
# 实时查看处理日志
tail -f log/processing.log

# 查看监控状态
cat log/monitor_state.json

# 查看队列状态
cat log/processing_queue.json
```

## 📊 状态文件说明

### 监控状态文件 (`log/monitor_state.json`)

```json
{
  "folders": {
    "动画系列A": {
      "hash": "abc123...",
      "last_check_time": 1703123456.789,
      "file_count": 24,
      "total_size": 5368709120,
      "last_modified": 1703123400.123
    }
  },
  "last_check": "2023-12-21T10:30:00"
}
```

### 处理队列文件 (`log/processing_queue.json`)

```json
[
  {
    "folder": "动画系列A",
    "file_count": 24,
    "total_size": 5368709120,
    "added_time": "2023-12-21T10:30:00",
    "status": "pending",
    "priority": 1,
    "start_time": "2023-12-21T10:35:00",
    "end_time": "2023-12-21T12:15:00"
  }
]
```

## 🎯 处理优先级

系统会根据文件夹大小自动分配优先级：

- **优先级 1 (高)**: ≤10个文件且≤5GB
- **优先级 2 (中)**: ≤50个文件且≤20GB  
- **优先级 3 (低)**: 大型文件夹

## 🔍 检测逻辑

### 文件夹完成检测

1. **计算文件夹Hash**: 基于文件路径和大小
2. **比较变化**: 与上次检查的Hash对比
3. **稳定时间**: 无变化超过10分钟认为完成
4. **自动加队**: 完成的文件夹自动加入处理队列

### 处理流程

1. **队列获取**: 从队列中按优先级取任务
2. **文件下载**: 从魔搭仓库下载视频文件
3. **批次处理**: 按配置分批处理视频
4. **结果上传**: 处理结果上传到输出仓库
5. **状态更新**: 更新队列中的任务状态

## 📈 监控指标

### 实时监控

```bash
# 查看系统资源
htop

# 查看磁盘使用
df -h /tmp

# 查看网络连接
netstat -an | grep modelscope

# 查看处理进度
watch -n 5 'python3 tools/queue_processor.py --status'
```

### 性能统计

- **监控频率**: 每5分钟检查一次仓库
- **检测延迟**: 最多15分钟（5分钟间隔 + 10分钟稳定时间）
- **处理并发**: 默认1个，可配置
- **磁盘清理**: 每次处理完自动清理

## 🛠️ 故障排除

### 常见问题

1. **监控器停止工作**
   ```bash
   # 检查tmux会话
   tmux list-sessions
   
   # 重启监控器
   tmux kill-session -t animation_monitor
   bash start_monitoring.sh
   ```

2. **队列堆积**
   ```bash
   # 查看队列状态
   python3 tools/queue_processor.py --status
   
   # 增加并发数
   python3 tools/queue_processor.py --concurrent 2
   ```

3. **魔搭连接失败**
   ```bash
   # 重新登录
   modelscope login --token ms-30a739b2-842b-4fe7-8485-ab9b5114afb5
   
   # 测试连接
   python3 tools/modelscope_monitor.py --once
   ```

4. **磁盘空间不足**
   ```bash
   # 清理临时文件
   rm -rf /tmp/modelscope_*
   rm -rf /tmp/animation_*
   
   # 检查空间
   df -h /tmp
   ```

### 日志分析

```bash
# 查看错误日志
grep -i error log/processing.log

# 查看最近的处理记录
tail -n 100 log/processing.log

# 统计处理成功率
grep -c "批次处理成功" log/processing.log
grep -c "批次处理失败" log/processing.log
```

## 🎨 自定义配置

### 调整监控间隔

```bash
# 2分钟检查一次（更快响应）
python3 tools/modelscope_monitor.py --interval 120

# 10分钟检查一次（节省资源）
python3 tools/modelscope_monitor.py --interval 600
```

### 调整处理并发

```bash
# 提高并发数（需要更多资源）
python3 tools/queue_processor.py --concurrent 2

# 降低检查频率（节省CPU）
python3 tools/queue_processor.py --interval 120
```

### 修改稳定时间

在 `tools/modelscope_monitor.py` 中修改：

```python
self.min_folder_stable_time = 300  # 改为5分钟
```

## 🚀 最佳实践

### 生产环境

1. **使用systemd服务**
   ```bash
   # 创建服务文件
   sudo nano /etc/systemd/system/animation-monitor.service
   
   # 启用服务
   sudo systemctl enable animation-monitor
   sudo systemctl start animation-monitor
   ```

2. **设置日志轮转**
   ```bash
   # 配置logrotate
   sudo nano /etc/logrotate.d/animation-processor
   ```

3. **监控告警**
   ```bash
   # 使用cron检查服务状态
   */5 * * * * /usr/local/bin/check_animation_service.sh
   ```

### 开发调试

1. **详细日志**
   ```bash
   # 设置DEBUG级别
   export PYTHONPATH=.
   python3 -c "
   import logging
   logging.basicConfig(level=logging.DEBUG)
   from tools.modelscope_monitor import main
   main()
   "
   ```

2. **单步调试**
   ```bash
   # 只运行一次检查
   python3 tools/modelscope_monitor.py --once
   
   # 处理单个队列项
   python3 tools/queue_processor.py --concurrent 1
   ```

## 📞 支持信息

- **项目仓库**: https://github.com/ageless-h/3k-ani-mkv-av1
- **魔搭仓库**: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1
- **问题反馈**: 通过GitHub Issues提交

---

## 🎉 总结

自动监控系统让您可以：
- 💤 **无人值守**: 上传完成后自动开始处理
- 🎯 **智能优先**: 小文件夹优先，快速获得反馈
- 📊 **全程跟踪**: 完整的状态记录和日志
- 🔄 **持续运行**: 7x24小时监控和处理

只需运行 `bash start_monitoring.sh`，系统就会自动监控您的魔搭仓库并处理新上传的动画！ 