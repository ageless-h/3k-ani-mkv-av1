# è‡ªåŠ¨ç›‘æ§ä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬ç³»ç»Ÿç°åœ¨æ”¯æŒè‡ªåŠ¨ç›‘æ§é­”æ­ä»“åº“ [ageless/3k-animation-mkv-av1](https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1)ï¼Œå½“æ£€æµ‹åˆ°æ–‡ä»¶å¤¹ä¸Šä¼ å®Œæˆæ—¶ï¼Œè‡ªåŠ¨å°†å…¶åŠ å…¥å¤„ç†é˜Ÿåˆ—å¹¶å¼€å§‹å¤„ç†ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- **ğŸ“¡ å®æ—¶ç›‘æ§**: æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡é­”æ­ä»“åº“æ›´æ–°
- **ğŸ§  æ™ºèƒ½æ£€æµ‹**: æ–‡ä»¶å¤¹10åˆ†é’Ÿå†…æ— å˜åŒ–å³è®¤ä¸ºä¸Šä¼ å®Œæˆ
- **âš¡ è‡ªåŠ¨é˜Ÿåˆ—**: å®Œæˆçš„æ–‡ä»¶å¤¹è‡ªåŠ¨åŠ å…¥å¤„ç†é˜Ÿåˆ—
- **ğŸ­ ä¼˜å…ˆçº§**: å°æ–‡ä»¶å¤¹ä¼˜å…ˆå¤„ç†ï¼Œæé«˜æ•ˆç‡
- **ğŸ“Š çŠ¶æ€è·Ÿè¸ª**: å®Œæ•´çš„å¤„ç†çŠ¶æ€å’Œè¿›åº¦è®°å½•

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. è‡ªåŠ¨ç›‘æ§æ¨¡å¼ï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨ç›‘æ§ç³»ç»Ÿï¼ˆåŒ…å«ç›‘æ§å™¨å’Œå¤„ç†å™¨ï¼‰
bash start_monitoring.sh
```

è¿™å°†å¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ï¼š
- **ç›‘æ§å™¨**: æŒç»­ç›‘æ§é­”æ­ä»“åº“å˜åŒ–
- **å¤„ç†å™¨**: ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡å¹¶å¤„ç†

### 2. æ‰‹åŠ¨æ¨¡å¼

```bash
# åªè¿è¡Œä¸€æ¬¡æ£€æŸ¥
python3 tools/modelscope_monitor.py --once

# æŸ¥çœ‹å½“å‰é˜Ÿåˆ—çŠ¶æ€
python3 tools/queue_processor.py --status

# æ‰‹åŠ¨å¤„ç†é˜Ÿåˆ—
python3 tools/queue_processor.py
```

## ğŸ”§ é…ç½®å‚æ•°

### ç›‘æ§å™¨é…ç½®

```python
# åœ¨ tools/modelscope_monitor.py ä¸­
class ModelScopeMonitor:
    monitor_interval = 300              # 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    min_folder_stable_time = 600        # 10åˆ†é’Ÿç¨³å®šæ‰è®¤ä¸ºå®Œæˆ
```

### å¤„ç†å™¨é…ç½®

```python
# åœ¨ tools/queue_processor.py ä¸­
class QueueProcessor:
    check_interval = 60                 # 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—
    max_concurrent = 1                  # æœ€å¤§å¹¶å‘å¤„ç†æ•°
```

## ğŸ“‹ ç®¡ç†å‘½ä»¤

### ç›‘æ§ç®¡ç†

```bash
# æŸ¥çœ‹tmuxä¼šè¯
tmux list-sessions

# è¿æ¥åˆ°ç›‘æ§å™¨
tmux attach -t animation_monitor:0

# è¿æ¥åˆ°å¤„ç†å™¨
tmux attach -t animation_monitor:processor

# åœæ­¢æ•´ä¸ªç³»ç»Ÿ
tmux kill-session -t animation_monitor
```

### é˜Ÿåˆ—ç®¡ç†

```bash
# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
python3 tools/queue_processor.py --status

# æŸ¥çœ‹ç›‘æ§å™¨é˜Ÿåˆ—
python3 tools/modelscope_monitor.py --queue

# åªæ£€æŸ¥ä¸€æ¬¡ä»“åº“
python3 tools/modelscope_monitor.py --once
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# å®æ—¶æŸ¥çœ‹å¤„ç†æ—¥å¿—
tail -f log/processing.log

# æŸ¥çœ‹ç›‘æ§çŠ¶æ€
cat log/monitor_state.json

# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
cat log/processing_queue.json
```

## ğŸ“Š çŠ¶æ€æ–‡ä»¶è¯´æ˜

### ç›‘æ§çŠ¶æ€æ–‡ä»¶ (`log/monitor_state.json`)

```json
{
  "folders": {
    "åŠ¨ç”»ç³»åˆ—A": {
      "hash": "abc123...",
      "last_check_time": 1703123456.789,
      "file_count": 24,
      "total_size": 5368709120,
      "last_modified": 1703123400.123
    }
  },
  "last_check": "2023-12-21T10:30:00"
}
```

### å¤„ç†é˜Ÿåˆ—æ–‡ä»¶ (`log/processing_queue.json`)

```json
[
  {
    "folder": "åŠ¨ç”»ç³»åˆ—A",
    "file_count": 24,
    "total_size": 5368709120,
    "added_time": "2023-12-21T10:30:00",
    "status": "pending",
    "priority": 1,
    "start_time": "2023-12-21T10:35:00",
    "end_time": "2023-12-21T12:15:00"
  }
]
```

## ğŸ¯ å¤„ç†ä¼˜å…ˆçº§

ç³»ç»Ÿä¼šæ ¹æ®æ–‡ä»¶å¤¹å¤§å°è‡ªåŠ¨åˆ†é…ä¼˜å…ˆçº§ï¼š

- **ä¼˜å…ˆçº§ 1 (é«˜)**: â‰¤10ä¸ªæ–‡ä»¶ä¸”â‰¤5GB
- **ä¼˜å…ˆçº§ 2 (ä¸­)**: â‰¤50ä¸ªæ–‡ä»¶ä¸”â‰¤20GB  
- **ä¼˜å…ˆçº§ 3 (ä½)**: å¤§å‹æ–‡ä»¶å¤¹

## ğŸ” æ£€æµ‹é€»è¾‘

### æ–‡ä»¶å¤¹å®Œæˆæ£€æµ‹

1. **è®¡ç®—æ–‡ä»¶å¤¹Hash**: åŸºäºæ–‡ä»¶è·¯å¾„å’Œå¤§å°
2. **æ¯”è¾ƒå˜åŒ–**: ä¸ä¸Šæ¬¡æ£€æŸ¥çš„Hashå¯¹æ¯”
3. **ç¨³å®šæ—¶é—´**: æ— å˜åŒ–è¶…è¿‡10åˆ†é’Ÿè®¤ä¸ºå®Œæˆ
4. **è‡ªåŠ¨åŠ é˜Ÿ**: å®Œæˆçš„æ–‡ä»¶å¤¹è‡ªåŠ¨åŠ å…¥å¤„ç†é˜Ÿåˆ—

### å¤„ç†æµç¨‹

1. **é˜Ÿåˆ—è·å–**: ä»é˜Ÿåˆ—ä¸­æŒ‰ä¼˜å…ˆçº§å–ä»»åŠ¡
2. **æ–‡ä»¶ä¸‹è½½**: ä»é­”æ­ä»“åº“ä¸‹è½½è§†é¢‘æ–‡ä»¶
3. **æ‰¹æ¬¡å¤„ç†**: æŒ‰é…ç½®åˆ†æ‰¹å¤„ç†è§†é¢‘
4. **ç»“æœä¸Šä¼ **: å¤„ç†ç»“æœä¸Šä¼ åˆ°è¾“å‡ºä»“åº“
5. **çŠ¶æ€æ›´æ–°**: æ›´æ–°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡çŠ¶æ€

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å®æ—¶ç›‘æ§

```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h /tmp

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -an | grep modelscope

# æŸ¥çœ‹å¤„ç†è¿›åº¦
watch -n 5 'python3 tools/queue_processor.py --status'
```

### æ€§èƒ½ç»Ÿè®¡

- **ç›‘æ§é¢‘ç‡**: æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»“åº“
- **æ£€æµ‹å»¶è¿Ÿ**: æœ€å¤š15åˆ†é’Ÿï¼ˆ5åˆ†é’Ÿé—´éš” + 10åˆ†é’Ÿç¨³å®šæ—¶é—´ï¼‰
- **å¤„ç†å¹¶å‘**: é»˜è®¤1ä¸ªï¼Œå¯é…ç½®
- **ç£ç›˜æ¸…ç†**: æ¯æ¬¡å¤„ç†å®Œè‡ªåŠ¨æ¸…ç†

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç›‘æ§å™¨åœæ­¢å·¥ä½œ**
   ```bash
   # æ£€æŸ¥tmuxä¼šè¯
   tmux list-sessions
   
   # é‡å¯ç›‘æ§å™¨
   tmux kill-session -t animation_monitor
   bash start_monitoring.sh
   ```

2. **é˜Ÿåˆ—å †ç§¯**
   ```bash
   # æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
   python3 tools/queue_processor.py --status
   
   # å¢åŠ å¹¶å‘æ•°
   python3 tools/queue_processor.py --concurrent 2
   ```

3. **é­”æ­è¿æ¥å¤±è´¥**
   ```bash
   # é‡æ–°ç™»å½•
   modelscope login --token ms-30a739b2-842b-4fe7-8485-ab9b5114afb5
   
   # æµ‹è¯•è¿æ¥
   python3 tools/modelscope_monitor.py --once
   ```

4. **ç£ç›˜ç©ºé—´ä¸è¶³**
   ```bash
   # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   rm -rf /tmp/modelscope_*
   rm -rf /tmp/animation_*
   
   # æ£€æŸ¥ç©ºé—´
   df -h /tmp
   ```

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep -i error log/processing.log

# æŸ¥çœ‹æœ€è¿‘çš„å¤„ç†è®°å½•
tail -n 100 log/processing.log

# ç»Ÿè®¡å¤„ç†æˆåŠŸç‡
grep -c "æ‰¹æ¬¡å¤„ç†æˆåŠŸ" log/processing.log
grep -c "æ‰¹æ¬¡å¤„ç†å¤±è´¥" log/processing.log
```

## ğŸ¨ è‡ªå®šä¹‰é…ç½®

### è°ƒæ•´ç›‘æ§é—´éš”

```bash
# 2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆæ›´å¿«å“åº”ï¼‰
python3 tools/modelscope_monitor.py --interval 120

# 10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆèŠ‚çœèµ„æºï¼‰
python3 tools/modelscope_monitor.py --interval 600
```

### è°ƒæ•´å¤„ç†å¹¶å‘

```bash
# æé«˜å¹¶å‘æ•°ï¼ˆéœ€è¦æ›´å¤šèµ„æºï¼‰
python3 tools/queue_processor.py --concurrent 2

# é™ä½æ£€æŸ¥é¢‘ç‡ï¼ˆèŠ‚çœCPUï¼‰
python3 tools/queue_processor.py --interval 120
```

### ä¿®æ”¹ç¨³å®šæ—¶é—´

åœ¨ `tools/modelscope_monitor.py` ä¸­ä¿®æ”¹ï¼š

```python
self.min_folder_stable_time = 300  # æ”¹ä¸º5åˆ†é’Ÿ
```

## ğŸš€ æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒ

1. **ä½¿ç”¨systemdæœåŠ¡**
   ```bash
   # åˆ›å»ºæœåŠ¡æ–‡ä»¶
   sudo nano /etc/systemd/system/animation-monitor.service
   
   # å¯ç”¨æœåŠ¡
   sudo systemctl enable animation-monitor
   sudo systemctl start animation-monitor
   ```

2. **è®¾ç½®æ—¥å¿—è½®è½¬**
   ```bash
   # é…ç½®logrotate
   sudo nano /etc/logrotate.d/animation-processor
   ```

3. **ç›‘æ§å‘Šè­¦**
   ```bash
   # ä½¿ç”¨cronæ£€æŸ¥æœåŠ¡çŠ¶æ€
   */5 * * * * /usr/local/bin/check_animation_service.sh
   ```

### å¼€å‘è°ƒè¯•

1. **è¯¦ç»†æ—¥å¿—**
   ```bash
   # è®¾ç½®DEBUGçº§åˆ«
   export PYTHONPATH=.
   python3 -c "
   import logging
   logging.basicConfig(level=logging.DEBUG)
   from tools.modelscope_monitor import main
   main()
   "
   ```

2. **å•æ­¥è°ƒè¯•**
   ```bash
   # åªè¿è¡Œä¸€æ¬¡æ£€æŸ¥
   python3 tools/modelscope_monitor.py --once
   
   # å¤„ç†å•ä¸ªé˜Ÿåˆ—é¡¹
   python3 tools/queue_processor.py --concurrent 1
   ```

## ğŸ“ æ”¯æŒä¿¡æ¯

- **é¡¹ç›®ä»“åº“**: https://github.com/ageless-h/3k-ani-mkv-av1
- **é­”æ­ä»“åº“**: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1
- **é—®é¢˜åé¦ˆ**: é€šè¿‡GitHub Issuesæäº¤

---

## ğŸ‰ æ€»ç»“

è‡ªåŠ¨ç›‘æ§ç³»ç»Ÿè®©æ‚¨å¯ä»¥ï¼š
- ğŸ’¤ **æ— äººå€¼å®ˆ**: ä¸Šä¼ å®Œæˆåè‡ªåŠ¨å¼€å§‹å¤„ç†
- ğŸ¯ **æ™ºèƒ½ä¼˜å…ˆ**: å°æ–‡ä»¶å¤¹ä¼˜å…ˆï¼Œå¿«é€Ÿè·å¾—åé¦ˆ
- ğŸ“Š **å…¨ç¨‹è·Ÿè¸ª**: å®Œæ•´çš„çŠ¶æ€è®°å½•å’Œæ—¥å¿—
- ğŸ”„ **æŒç»­è¿è¡Œ**: 7x24å°æ—¶ç›‘æ§å’Œå¤„ç†

åªéœ€è¿è¡Œ `bash start_monitoring.sh`ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨ç›‘æ§æ‚¨çš„é­”æ­ä»“åº“å¹¶å¤„ç†æ–°ä¸Šä¼ çš„åŠ¨ç”»ï¼ 