# é­”æ­ç¤¾åŒºä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬ç³»ç»Ÿç°å·²å‡çº§ä¸ºåŸºäºé­”æ­ç¤¾åŒºçš„äº‘ç«¯æ•°æ®å¤„ç†æ¨¡å¼ï¼Œå®Œå…¨æ›¿ä»£äº†ä¹‹å‰å¤æ‚çš„NASç½‘ç»œé…ç½®ã€‚æ‰€æœ‰æ•°æ®é€šè¿‡é­”æ­ç¤¾åŒºçš„æ•°æ®é›†ä»“åº“è¿›è¡Œç®¡ç†ï¼Œå®ç°äº†æ›´ç®€å•ã€æ›´å¯é çš„æ•°æ®æµã€‚

## ğŸ”— ç›¸å…³ä»“åº“

### è¾“å…¥ä»“åº“
- **ä»“åº“ID**: `ageless/3k-animation-mkv-av1`
- **è®¿é—®åœ°å€**: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1
- **ç”¨é€”**: å­˜å‚¨å¾…å¤„ç†çš„åŠ¨ç”»è§†é¢‘æ–‡ä»¶

### è¾“å‡ºä»“åº“
- **MKVè¾“å‡º**: `ageless/3k-animation-mkv-av1-output`
  - åœ°å€: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1-output
  - ç”¨é€”: å­˜å‚¨è½¬æ¢åçš„MKV+AV1è§†é¢‘æ–‡ä»¶

- **WebPè¾“å‡º**: `ageless/3k-animation-mkv-av1-output-webp`
  - åœ°å€: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1-output-webp
  - ç”¨é€”: å­˜å‚¨å‹ç¼©åçš„WebPå›¾åƒå½’æ¡£

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/ageless-h/3k-ani-mkv-av1.git
cd 3k-animation-mkv-av1

# ä¸€é”®éƒ¨ç½²
python3 deploy.py

# å¯åŠ¨å¤„ç†
bash run.sh
```

### 2. é…ç½®è¯´æ˜

ä¸»è¦é…ç½®åœ¨ `config/config.py`:

```python
class Config:
    # éƒ¨ç½²æ¨¡å¼ï¼ˆé»˜è®¤ä¸ºé­”æ­æ¨¡å¼ï¼‰
    DEPLOYMENT_MODE = "modelscope"
    
    # é­”æ­ç¤¾åŒºToken
    MODELSCOPE_TOKEN = "ms-30a739b2-842b-4fe7-8485-ab9b5114afb5"
    
    # æ‰¹å¤„ç†è®¾ç½®
    MAX_EPISODES_PER_BATCH = 30     # æ¯æ‰¹å¤„ç†çš„è§†é¢‘æ•°é‡
    MIN_FREE_SPACE_GB = 10          # æœ€å°ä¿ç•™ç£ç›˜ç©ºé—´
```

## ğŸ”„ æ•°æ®æµç¨‹

### å¤„ç†æµç¨‹

1. **æ•°æ®ä¸‹è½½**: ä»è¾“å…¥ä»“åº“æ‰¹é‡ä¸‹è½½è§†é¢‘æ–‡ä»¶
2. **æœ¬åœ°å¤„ç†**: 
   - è§†é¢‘è½¬æ¢ä¸ºMKV+AV1æ ¼å¼
   - åœºæ™¯æ£€æµ‹å’Œå¸§æå–
   - å›¾åƒå¤„ç†å’ŒWebPå‹ç¼©
3. **ç»“æœä¸Šä¼ **:
   - MKVæ–‡ä»¶ä¸Šä¼ åˆ°MKVè¾“å‡ºä»“åº“
   - WebPå½’æ¡£ä¸Šä¼ åˆ°WebPè¾“å‡ºä»“åº“
4. **æ¸…ç†**: åˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶

### æµç¨‹å›¾

```
è¾“å…¥ä»“åº“ â†’ æœ¬åœ°ä¸‹è½½ â†’ è§†é¢‘å¤„ç† â†’ å›¾åƒå¤„ç† â†’ åˆ›å»ºå½’æ¡£ â†’ ä¸Šä¼ ç»“æœ â†’ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   â†“           â†“          â†“          â†“          â†“          â†“
é­”æ­æ•°æ®é›†   /tmpç¼“å­˜   MKV+AV1   WebPè½¬æ¢   tar.gz   è¾“å‡ºä»“åº“
```

## ğŸ“‹ ä½¿ç”¨å‘½ä»¤

### åŸºæœ¬æ“ä½œ

```bash
# å¯åŠ¨å®Œæ•´å¤„ç†æµç¨‹
bash run.sh

# è¿è¡Œç¯å¢ƒæ£€æŸ¥
python3 tools/check_environment.py

# æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶
python3 doc/upload.py file --path /path/to/file --repo output_webp

# æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶å¤¹
python3 doc/upload.py folder --path /path/to/folder --repo output_mkv

# åˆ—å‡ºå¯ç”¨ä»“åº“
python3 doc/upload.py list
```

### é«˜çº§æ“ä½œ

```bash
# ä½¿ç”¨é­”æ­CLIä¸‹è½½
modelscope download ageless/3k-animation-mkv-av1 filelist.txt

# æŸ¥çœ‹ä¸‹è½½è¿›åº¦
ls -la /tmp/modelscope_downloads/

# æ‰‹åŠ¨æ¸…ç†ç¼“å­˜
rm -rf /tmp/modelscope_cache/*
```

## ğŸ› ï¸ é…ç½®å‚æ•°è¯¦è§£

### é­”æ­é…ç½®

```python
# config/modelscope_config.py
class ModelScopeConfig:
    # API Token
    MODELSCOPE_TOKEN = "ms-30a739b2-842b-4fe7-8485-ab9b5114afb5"
    
    # ä»“åº“é…ç½®
    REPOSITORIES = {
        'input': 'ageless/3k-animation-mkv-av1',
        'output_mkv': 'ageless/3k-animation-mkv-av1-output',
        'output_webp': 'ageless/3k-animation-mkv-av1-output-webp'
    }
    
    # æ‰¹å¤„ç†é…ç½®
    DOWNLOAD_BATCH_SIZE = 20        # æ¯æ‰¹ä¸‹è½½è§†é¢‘æ•°é‡
    MAX_EPISODES_PER_BATCH = 30     # æ¯æ‰¹å¤„ç†è§†é¢‘æ•°é‡
    
    # ç½‘ç»œé…ç½®
    DOWNLOAD_TIMEOUT = 300          # ä¸‹è½½è¶…æ—¶(ç§’)
    UPLOAD_TIMEOUT = 600            # ä¸Šä¼ è¶…æ—¶(ç§’)
    MAX_RETRY_COUNT = 3             # æœ€å¤§é‡è¯•æ¬¡æ•°
    
    # å¹¶å‘é…ç½®
    MAX_DOWNLOAD_WORKERS = 4        # ä¸‹è½½å¹¶å‘æ•°
    MAX_UPLOAD_WORKERS = 2          # ä¸Šä¼ å¹¶å‘æ•°
```

### å¤„ç†é…ç½®

```python
# config/config.py
class Config:
    # è§†é¢‘å¤„ç†å‚æ•°
    FFMPEG_AV1_PARAMS = [
        "-c:v", "av1_nvenc",        # NVIDIAç¡¬ä»¶ç¼–ç 
        "-preset", "p7",            # æœ€é«˜è´¨é‡
        "-crf", "23",               # è´¨é‡æ§åˆ¶
        "-c:a", "copy",             # éŸ³é¢‘å¤åˆ¶
        "-c:s", "copy",             # å­—å¹•å¤åˆ¶
        "-f", "matroska"            # MKVæ ¼å¼
    ]
    
    # å›¾åƒå¤„ç†å‚æ•°
    MAX_IMAGE_SIZE = 2048           # æœ€å¤§å›¾åƒå°ºå¯¸
    WEBP_QUALITY = 90               # WebPè´¨é‡
    
    # åœºæ™¯æ£€æµ‹
    SCENE_DETECTION_THRESHOLD = 30.0
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—æ–‡ä»¶

- `log/processing.log` - ä¸»è¦å¤„ç†æ—¥å¿—
- `log/animation_processor.log` - å¤„ç†å™¨è¯¦ç»†æ—¥å¿—
- `log/upload.log` - ä¸Šä¼ æ—¥å¿—

### è¿›åº¦ç›‘æ§

```bash
# æŸ¥çœ‹å¤„ç†è¿›åº¦
tail -f log/processing.log

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h /tmp

# æŸ¥çœ‹é­”æ­ç¼“å­˜
du -sh /tmp/modelscope_*
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é­”æ­ç™»å½•å¤±è´¥**
   ```bash
   # é‡æ–°ç™»å½•
   modelscope login --token ms-30a739b2-842b-4fe7-8485-ab9b5114afb5
   
   # æ£€æŸ¥tokenæœ‰æ•ˆæ€§
   python3 -c "from config.modelscope_config import ModelScopeConfig; print(ModelScopeConfig.validate_token())"
   ```

2. **ä¸‹è½½å¤±è´¥**
   ```bash
   # æ¸…ç†ç¼“å­˜é‡è¯•
   rm -rf /tmp/modelscope_cache/*
   
   # æ‰‹åŠ¨æµ‹è¯•ä¸‹è½½
   modelscope download ageless/3k-animation-mkv-av1 --include "*.mp4"
   ```

3. **ä¸Šä¼ å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   ping www.modelscope.cn
   
   # æ‰‹åŠ¨æµ‹è¯•ä¸Šä¼ 
   python3 doc/upload.py file --path test.txt --repo input
   ```

4. **ç£ç›˜ç©ºé—´ä¸è¶³**
   ```bash
   # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   rm -rf /tmp/animation_*
   rm -rf /tmp/modelscope_downloads/*
   
   # å¢åŠ ç£ç›˜ç©ºé—´ç›‘æ§
   watch -n 5 'df -h /tmp'
   ```

### æ€§èƒ½ä¼˜åŒ–

1. **è°ƒæ•´æ‰¹æ¬¡å¤§å°**
   - å‡å°‘ `MAX_EPISODES_PER_BATCH` ä»¥é™ä½å†…å­˜ä½¿ç”¨
   - å¢åŠ  `DOWNLOAD_BATCH_SIZE` ä»¥æé«˜ä¸‹è½½æ•ˆç‡

2. **ç½‘ç»œä¼˜åŒ–**
   - è°ƒæ•´ `MAX_DOWNLOAD_WORKERS` å’Œ `MAX_UPLOAD_WORKERS`
   - æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´è¶…æ—¶è®¾ç½®

3. **å­˜å‚¨ä¼˜åŒ–**
   - ä½¿ç”¨SSDå­˜å‚¨ä¸´æ—¶æ–‡ä»¶
   - å®šæœŸæ¸…ç†ç¼“å­˜ç›®å½•

## ğŸ¯ æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ä½¿ç”¨tmuxæˆ–screenè¿è¡Œé•¿æ—¶é—´ä»»åŠ¡**
   ```bash
   tmux new-session -d -s animation 'bash run.sh'
   tmux attach -t animation
   ```

2. **è®¾ç½®å®šæ—¶æ¸…ç†**
   ```bash
   # æ·»åŠ åˆ°crontab
   0 2 * * * /bin/bash -c 'find /tmp/modelscope_* -mtime +7 -delete'
   ```

3. **ç›‘æ§ç³»ç»Ÿèµ„æº**
   ```bash
   # å®‰è£…htopç›‘æ§
   sudo apt install htop
   htop
   ```

### å¼€å‘ç¯å¢ƒå»ºè®®

1. **ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ**
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **è°ƒè¯•æ¨¡å¼**
   ```bash
   # è®¾ç½®è°ƒè¯•æ—¥å¿—çº§åˆ«
   export PYTHONPATH=.
   python3 -c "
   import logging
   logging.basicConfig(level=logging.DEBUG)
   from src.main import main
   main()
   "
   ```

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥é­”æ­ç¤¾åŒºä»“åº“è®¿é—®æƒé™
3. éªŒè¯ç½‘ç»œè¿æ¥å’Œtokenæœ‰æ•ˆæ€§
4. å‚è€ƒæœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†

æ›´å¤šæŠ€æœ¯æ”¯æŒè¯·è®¿é—®é¡¹ç›®ä»“åº“ï¼šhttps://github.com/ageless-h/3k-ani-mkv-av1 