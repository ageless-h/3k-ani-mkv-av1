# 魔搭社区使用指南

## 📖 概述

本系统现已升级为基于魔搭社区的云端数据处理模式，完全替代了之前复杂的NAS网络配置。所有数据通过魔搭社区的数据集仓库进行管理，实现了更简单、更可靠的数据流。

## 🔗 相关仓库

### 输入仓库
- **仓库ID**: `ageless/3k-animation-mkv-av1`
- **访问地址**: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1
- **用途**: 存储待处理的动画视频文件

### 输出仓库
- **MKV输出**: `ageless/3k-animation-mkv-av1-output`
  - 地址: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1-output
  - 用途: 存储转换后的MKV+AV1视频文件

- **WebP输出**: `ageless/3k-animation-mkv-av1-output-webp`
  - 地址: https://www.modelscope.cn/datasets/ageless/3k-animation-mkv-av1-output-webp
  - 用途: 存储压缩后的WebP图像归档

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/ageless-h/3k-ani-mkv-av1.git
cd 3k-animation-mkv-av1

# 一键部署
python3 deploy.py

# 启动处理
bash run.sh
```

### 2. 配置说明

主要配置在 `config/config.py`:

```python
class Config:
    # 部署模式（默认为魔搭模式）
    DEPLOYMENT_MODE = "modelscope"
    
    # 魔搭社区Token
    MODELSCOPE_TOKEN = "ms-30a739b2-842b-4fe7-8485-ab9b5114afb5"
    
    # 批处理设置
    MAX_EPISODES_PER_BATCH = 30     # 每批处理的视频数量
    MIN_FREE_SPACE_GB = 10          # 最小保留磁盘空间
```

## 🔄 数据流程

### 处理流程

1. **数据下载**: 从输入仓库批量下载视频文件
2. **本地处理**: 
   - 视频转换为MKV+AV1格式
   - 场景检测和帧提取
   - 图像处理和WebP压缩
3. **结果上传**:
   - MKV文件上传到MKV输出仓库
   - WebP归档上传到WebP输出仓库
4. **清理**: 删除本地临时文件

### 流程图

```
输入仓库 → 本地下载 → 视频处理 → 图像处理 → 创建归档 → 上传结果 → 清理临时文件
   ↓           ↓          ↓          ↓          ↓          ↓
魔搭数据集   /tmp缓存   MKV+AV1   WebP转换   tar.gz   输出仓库
```

## 📋 使用命令

### 基本操作

```bash
# 启动完整处理流程
bash run.sh

# 运行环境检查
python3 tools/check_environment.py

# 手动上传文件
python3 doc/upload.py file --path /path/to/file --repo output_webp

# 手动上传文件夹
python3 doc/upload.py folder --path /path/to/folder --repo output_mkv

# 列出可用仓库
python3 doc/upload.py list
```

### 高级操作

```bash
# 使用魔搭CLI下载
modelscope download ageless/3k-animation-mkv-av1 filelist.txt

# 查看下载进度
ls -la /tmp/modelscope_downloads/

# 手动清理缓存
rm -rf /tmp/modelscope_cache/*
```

## 🛠️ 配置参数详解

### 魔搭配置

```python
# config/modelscope_config.py
class ModelScopeConfig:
    # API Token
    MODELSCOPE_TOKEN = "ms-30a739b2-842b-4fe7-8485-ab9b5114afb5"
    
    # 仓库配置
    REPOSITORIES = {
        'input': 'ageless/3k-animation-mkv-av1',
        'output_mkv': 'ageless/3k-animation-mkv-av1-output',
        'output_webp': 'ageless/3k-animation-mkv-av1-output-webp'
    }
    
    # 批处理配置
    DOWNLOAD_BATCH_SIZE = 20        # 每批下载视频数量
    MAX_EPISODES_PER_BATCH = 30     # 每批处理视频数量
    
    # 网络配置
    DOWNLOAD_TIMEOUT = 300          # 下载超时(秒)
    UPLOAD_TIMEOUT = 600            # 上传超时(秒)
    MAX_RETRY_COUNT = 3             # 最大重试次数
    
    # 并发配置
    MAX_DOWNLOAD_WORKERS = 4        # 下载并发数
    MAX_UPLOAD_WORKERS = 2          # 上传并发数
```

### 处理配置

```python
# config/config.py
class Config:
    # 视频处理参数
    FFMPEG_AV1_PARAMS = [
        "-c:v", "av1_nvenc",        # NVIDIA硬件编码
        "-preset", "p7",            # 最高质量
        "-crf", "23",               # 质量控制
        "-c:a", "copy",             # 音频复制
        "-c:s", "copy",             # 字幕复制
        "-f", "matroska"            # MKV格式
    ]
    
    # 图像处理参数
    MAX_IMAGE_SIZE = 2048           # 最大图像尺寸
    WEBP_QUALITY = 90               # WebP质量
    
    # 场景检测
    SCENE_DETECTION_THRESHOLD = 30.0
```

## 📊 监控和日志

### 日志文件

- `log/processing.log` - 主要处理日志
- `log/animation_processor.log` - 处理器详细日志
- `log/upload.log` - 上传日志

### 进度监控

```bash
# 查看处理进度
tail -f log/processing.log

# 查看磁盘使用
df -h /tmp

# 查看魔搭缓存
du -sh /tmp/modelscope_*
```

## 🔧 故障排除

### 常见问题

1. **魔搭登录失败**
   ```bash
   # 重新登录
   modelscope login --token ms-30a739b2-842b-4fe7-8485-ab9b5114afb5
   
   # 检查token有效性
   python3 -c "from config.modelscope_config import ModelScopeConfig; print(ModelScopeConfig.validate_token())"
   ```

2. **下载失败**
   ```bash
   # 清理缓存重试
   rm -rf /tmp/modelscope_cache/*
   
   # 手动测试下载
   modelscope download ageless/3k-animation-mkv-av1 --include "*.mp4"
   ```

3. **上传失败**
   ```bash
   # 检查网络连接
   ping www.modelscope.cn
   
   # 手动测试上传
   python3 doc/upload.py file --path test.txt --repo input
   ```

4. **磁盘空间不足**
   ```bash
   # 清理临时文件
   rm -rf /tmp/animation_*
   rm -rf /tmp/modelscope_downloads/*
   
   # 增加磁盘空间监控
   watch -n 5 'df -h /tmp'
   ```

### 性能优化

1. **调整批次大小**
   - 减少 `MAX_EPISODES_PER_BATCH` 以降低内存使用
   - 增加 `DOWNLOAD_BATCH_SIZE` 以提高下载效率

2. **网络优化**
   - 调整 `MAX_DOWNLOAD_WORKERS` 和 `MAX_UPLOAD_WORKERS`
   - 根据网络状况调整超时设置

3. **存储优化**
   - 使用SSD存储临时文件
   - 定期清理缓存目录

## 🎯 最佳实践

### 生产环境建议

1. **使用tmux或screen运行长时间任务**
   ```bash
   tmux new-session -d -s animation 'bash run.sh'
   tmux attach -t animation
   ```

2. **设置定时清理**
   ```bash
   # 添加到crontab
   0 2 * * * /bin/bash -c 'find /tmp/modelscope_* -mtime +7 -delete'
   ```

3. **监控系统资源**
   ```bash
   # 安装htop监控
   sudo apt install htop
   htop
   ```

### 开发环境建议

1. **使用虚拟环境**
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **调试模式**
   ```bash
   # 设置调试日志级别
   export PYTHONPATH=.
   python3 -c "
   import logging
   logging.basicConfig(level=logging.DEBUG)
   from src.main import main
   main()
   "
   ```

## 📞 支持和反馈

如果您在使用过程中遇到问题，请：

1. 查看日志文件获取详细错误信息
2. 检查魔搭社区仓库访问权限
3. 验证网络连接和token有效性
4. 参考本文档的故障排除部分

更多技术支持请访问项目仓库：https://github.com/ageless-h/3k-ani-mkv-av1 