# 🚀 Linux服务器部署指南

基于您当前的环境检查结果，这里是具体的部署步骤。

## 📊 当前环境状况

✅ **已就绪的环境**：
- Python 3.10.14 ✓
- 1007.7 GB 内存 ✓
- RTX 4090 GPU (24GB显存) ✓
- FFmpeg + AV1硬件编码 ✓
- 所有Python包已安装 ✓
- 52,982个视频文件列表 ✓

⚠️ **需要解决的问题**：
- libwebp缺失（将使用Pillow备用方案）
- NAS网络路径配置
- SSH密钥认证设置

## 🔧 立即执行的修复步骤

### 1. 更新代码到最新版本

```bash
cd ~/3k-ani-mkv-av1
git pull
```

### 2. 配置网络访问

```bash
# 测试与NAS的连接
ping -c 3 100.74.107.59

# 检查tailscale状态
tailscale status

# 设置SSH密钥认证（如果还没有）
if [ ! -f ~/.ssh/id_rsa ]; then
    ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
    echo "请在NAS上运行: ssh-copy-id root@100.95.10.55"
fi

# 测试SSH连接
ssh -o ConnectTimeout=5 root@100.74.107.59 "echo 'SSH连接成功'"
```

### 3. 创建并配置config.py

```bash
# 复制配置模板
cp config_example.py config.py

# 编辑配置文件
nano config.py
```

**重要配置修改**：
```python
# 在config.py中修改以下配置
class Config:
    # 使用本地输出目录（避免NAS挂载问题）
    OUTPUT_DIR = "/root/output/animation"
    VIDEO_OUTPUT_DIR = "/root/output/video"
    
    # 文件列表路径（已存在）
    FILELIST_PATH = "/root/3k-ani-mkv-av1/filelist.txt"
    
    # NAS相关路径（用于最终传输）
    NAS_OUTPUT_DIR = "/volume1/db/1_ai/data/image/animation"
    
    # 根据您的1TB内存，可以提高性能参数
    MAX_WORKERS = 4
    MAX_EPISODES_PER_BATCH = 50
```

### 4. 创建输出目录

```bash
mkdir -p /root/output/animation
mkdir -p /root/output/video
mkdir -p /tmp/animation_processing
```

### 5. 安装libwebp（可选，提升性能）

```bash
# 下载libwebp
cd /tmp
wget https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.3.2-linux-x86-64.tar.gz
tar -xzf libwebp-1.3.2-linux-x86-64.tar.gz

# 复制到项目目录
cd ~/3k-ani-mkv-av1
mkdir -p libwebp/bin
cp /tmp/libwebp-1.3.2-linux-x86-64/bin/cwebp libwebp/bin/
chmod +x libwebp/bin/cwebp

# 测试libwebp
./libwebp/bin/cwebp -version
```

## 🏃‍♂️ 运行系统

### 1. 最终环境检查

```bash
python check_environment.py
```

### 2. 功能测试

```bash
python test_system.py
```

### 3. 开始处理

```bash
# 方式1: 使用启动脚本（推荐）
bash run.sh

# 方式2: 直接运行
python main.py

# 方式3: 后台运行
nohup python main.py > processing.log 2>&1 &
```

## 📊 监控处理进度

### 实时监控命令

```bash
# 查看处理日志
tail -f /tmp/animation_processing/animation_processor.log

# 查看进度
watch -n 10 'cat /tmp/animation_processing/progress.json | jq .'

# 监控系统资源
watch -n 2 'echo "=== GPU ===" && nvidia-smi && echo "=== 磁盘 ===" && df -h /tmp && echo "=== 内存 ===" && free -h'

# 查看输出目录
ls -lah /root/output/animation/

# 查看处理统计
echo "已完成系列: $(find /root/output/animation -name "*.tar.gz" | wc -l)"
```

## 🔗 NAS传输策略

由于您的环境是通过tailscale连接NAS，建议采用以下策略：

### 自动传输脚本

创建 `upload_to_nas.sh`：

```bash
#!/bin/bash

# 自动上传完成的tar包到NAS
UPLOAD_LOG="/tmp/upload.log"
LOCAL_DIR="/root/output/animation"
NAS_DIR="/volume1/db/1_ai/data/image/animation"
NAS_IP="100.74.107.59"

echo "$(date): 开始上传检查" >> $UPLOAD_LOG

for archive in $LOCAL_DIR/*.tar.gz; do
    if [ -f "$archive" ]; then
        filename=$(basename "$archive")
        
        # 检查NAS上是否已存在
        if ! ssh root@$NAS_IP "test -f $NAS_DIR/$filename"; then
            echo "$(date): 上传 $filename" >> $UPLOAD_LOG
            
            # 上传文件
            if scp "$archive" root@$NAS_IP:$NAS_DIR/; then
                echo "$(date): $filename 上传成功" >> $UPLOAD_LOG
                
                # 验证后删除本地文件
                if ssh root@$NAS_IP "test -f $NAS_DIR/$filename"; then
                    rm "$archive"
                    echo "$(date): $filename 本地文件已清理" >> $UPLOAD_LOG
                fi
            else
                echo "$(date): $filename 上传失败" >> $UPLOAD_LOG
            fi
        fi
    fi
done
```

### 定期执行上传

```bash
# 添加到crontab，每30分钟检查一次
echo "*/30 * * * * /root/3k-ani-mkv-av1/upload_to_nas.sh" | crontab -
```

## ⚡ 性能优化建议

基于您的硬件配置（1TB内存 + RTX 4090）：

```python
# 在config.py中使用高性能配置
class Config:
    # 提高并发数
    MAX_WORKERS = 6
    
    # 增大批处理大小
    MAX_EPISODES_PER_BATCH = 100
    
    # 提高图像质量
    WEBP_QUALITY = 95
    
    # 使用更激进的FFmpeg参数
    FFMPEG_AV1_PARAMS = [
        "-c:v", "av1_nvenc",
        "-preset", "p6",      # 从p7改为p6，稍快一些
        "-crf", "20",         # 从23改为20，更高质量
        "-c:a", "copy",
        "-c:s", "copy",
        "-f", "matroska"
    ]
```

## 🚨 故障排除

### 常见问题及解决方案

1. **SSH连接失败**
   ```bash
   ssh-keygen -t rsa -b 4096
   ssh-copy-id root@100.74.107.59
   ```

2. **磁盘空间不足**
   ```bash
   # 检查空间
   df -h
   
   # 清理临时文件
   rm -rf /tmp/animation_processing/*
   ```

3. **GPU内存不足**
   ```bash
   # 降低并发数
   # 在config.py中设置 MAX_WORKERS = 2
   ```

4. **网络传输中断**
   ```bash
   # 重新运行上传脚本
   bash upload_to_nas.sh
   ```

## 📈 预期性能

基于您的配置，预期性能：

- **处理速度**: 约500-1000个视频/小时
- **场景检测**: ~20x实时速度
- **图像转换**: ~200-500帧/秒
- **存储需求**: 约原视频大小的20%

## 🎯 下一步行动

1. **立即执行**:
   ```bash
   cd ~/3k-ani-mkv-av1
   git pull
   cp config_example.py config.py
   nano config.py  # 修改配置
   python check_environment.py
   ```

2. **开始处理**:
   ```bash
   python main.py
   ```

3. **监控进度**:
   ```bash
   tail -f /tmp/animation_processing/animation_processor.log
   ```

如果遇到任何问题，请检查日志文件或重新运行环境检查脚本！ 