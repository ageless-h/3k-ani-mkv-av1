# 3K动画处理系统 - 快速入门指南

本指南将帮助您在10分钟内完成项目部署和首次运行。

## 🎯 部署目标

部署完成后，您将拥有一个完整的动画视频处理系统，能够：
- 从NAS读取动画视频
- 转换为MKV+AV1格式
- 提取场景中间帧
- 生成WebP图像归档

## 📋 前置要求

### 硬件要求
- **CPU**: 多核处理器 (推荐8核+)
- **GPU**: NVIDIA RTX 4090 (支持AV1硬件编码)
- **内存**: 16GB+ RAM
- **存储**: 50GB+ 可用空间

### 软件要求
- **操作系统**: Linux (Ubuntu 20.04+, CentOS 8+)
- **Python**: 3.8+
- **Git**: 最新版本
- **FFmpeg**: 支持AV1编码的版本

### 网络要求
- **Tailscale VPN**: 用于连接NAS
- **稳定网络**: 用于传输大文件

## 🚀 一键部署

### 步骤1: 克隆项目

```bash
# 在Linux服务器上执行
git clone https://github.com/ageless-h/3k-ani-mkv-av1.git
cd 3k-animation-mkv-av1
```

### 步骤2: 运行部署脚本

```bash
python3 deploy.py
```

部署脚本会自动：
1. **检查系统环境** - 验证Python、Git、FFmpeg等
2. **创建虚拟环境** - 隔离Python依赖
3. **安装依赖包** - 安装所有必要的Python包
4. **安装libwebp** - 高性能WebP转换工具
5. **创建目录结构** - 设置日志和输出目录
6. **运行配置向导** - 交互式配置系统

### 步骤3: 配置向导

配置向导会询问以下信息：

#### 部署模式选择
```
1. 单机模式 (本地处理)
2. 远程模式 (Linux服务器处理) ← 推荐
3. 中介模式 (通过中介机传输)
```

#### NAS连接配置
- **NAS IP地址**: Tailscale网络中的NAS IP
- **SSH用户名**: 通常是 `root`、`admin` 或 `ugos`
- **SSH端口**: 默认 `22`

#### 路径配置
- **源视频目录**: NAS上的动画视频存放路径
- **输出目录**: 处理结果保存路径
- **临时目录**: 处理过程中的临时文件路径

#### 处理参数
- **每批最大集数**: 控制内存使用
- **并发线程数**: 根据CPU核心数设置
- **WebP质量**: 图像压缩质量 (推荐90%)

## ⚙️ 配置示例

### 典型绿联云配置

```python
class Config:
    # NAS连接
    NAS_IP = "100.74.107.59"
    SSH_USER = "root"
    SSH_PORT = 22
    
    # 路径配置
    SOURCE_DIR = "/volume1/db/5_video/archive"
    OUTPUT_DIR = "/root/output/animation"
    TEMP_DIR = "/tmp/animation_processing"
    
    # 处理参数
    MAX_EPISODES_PER_BATCH = 30
    MAX_WORKERS = 4
    WEBP_QUALITY = 90
    TARGET_SIZE = 2048
```

## 🔧 首次运行

### 步骤1: 环境验证

```bash
# 检查系统环境
python3 tools/check_environment.py

# 检查NAS连接
python3 tools/diagnose_nas.py
```

### 步骤2: 准备文件列表

```bash
# 如果有现成的文件列表
cp your_filelist.txt filelist.txt

# 或者从NAS获取文件列表
python3 tools/ugreen_nas_config.py
```

### 步骤3: 启动处理

```bash
# 前台运行 (测试用)
bash run.sh

# 后台运行 (生产环境)
nohup bash run.sh > processing.log 2>&1 &
```

### 步骤4: 监控进度

```bash
# 查看实时日志
tail -f log/processing.log

# 查看处理进度
tail -f processing.log | grep "进度"

# 检查GPU使用情况
nvidia-smi

# 检查磁盘使用情况
df -h
```

## 📊 性能优化

### GPU加速配置

确保NVIDIA驱动和CUDA已安装：
```bash
# 检查GPU状态
nvidia-smi

# 检查AV1编码支持
ffmpeg -encoders | grep av1_nvenc
```

### 并发处理调优

根据硬件配置调整参数：
```python
# 4核CPU推荐设置
MAX_WORKERS = 2

# 8核CPU推荐设置  
MAX_WORKERS = 4

# 16核CPU推荐设置
MAX_WORKERS = 6
```

### 磁盘空间管理

```bash
# 监控磁盘使用
watch -n 5 'df -h /tmp'

# 清理临时文件
rm -rf /tmp/animation_processing/*

# 压缩日志文件
gzip log/processing.log
```

## 🐛 常见问题

### Q: SSH连接失败？
```bash
# 检查Tailscale状态
tailscale status

# 测试SSH连接
ssh root@100.74.107.59

# 检查SSH服务
python3 tools/diagnose_nas.py
```

### Q: GPU编码不工作？
```bash
# 检查NVIDIA驱动
nvidia-smi

# 检查FFmpeg AV1支持
ffmpeg -encoders | grep av1

# 检查CUDA版本
nvcc --version
```

### Q: 磁盘空间不足？
```bash
# 检查空间使用
df -h

# 清理临时文件
python3 -c "
from src.archive_manager import ArchiveManager
manager = ArchiveManager()
manager.cleanup_temp_files('/tmp/animation_processing')
"
```

### Q: 内存不足？
调整批处理大小：
```python
# 减少每批处理的集数
MAX_EPISODES_PER_BATCH = 10

# 减少并发线程数
MAX_WORKERS = 2
```

## 📈 监控和维护

### 系统服务管理

如果安装了systemd服务：
```bash
# 启动服务
systemctl start 3k-animation

# 停止服务
systemctl stop 3k-animation

# 查看状态
systemctl status 3k-animation

# 查看日志
journalctl -u 3k-animation -f
```

### 定期维护

```bash
# 每周清理临时文件
find /tmp/animation_processing -type f -mtime +7 -delete

# 每月压缩旧日志
find log/ -name "*.log" -mtime +30 -exec gzip {} \;

# 检查磁盘健康
smartctl -a /dev/sda
```

## 🎯 下一步

部署完成后，您可以：

1. **优化配置**: 根据实际使用情况调整参数
2. **批量处理**: 处理大量动画视频
3. **监控优化**: 设置报警和自动化监控
4. **扩展功能**: 根据需要添加新特性

## 📚 更多资源

- [项目README](../README.md) - 完整项目说明
- [部署指南](部署指南.md) - 详细部署文档
- [SSH配置指南](绿联云SSH启用指南.md) - NAS SSH设置
- [故障排除](fix_nas_ssh.md) - 常见问题解决

---

**有问题？** 请查看 [项目Issues](https://github.com/ageless-h/3k-ani-mkv-av1/issues) 或提交新Issue。 